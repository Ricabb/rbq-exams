let questions=[],currentIndex=0,answers={},timeLeft,examNumber="1",lang="en",mode="exam",moduleKey="admin",timer;
const i18n={en:{title:"RBQ Exam",back:"← All Exams",prev:"Previous",next:"Next",submit:"Submit",qOf:(i,t)=>`Question ${i} / ${t}`,result:"Result",yourScore:(s,t)=>`You scored <strong>${s}</strong> / ${t}`,review:"Review",yourAnswer:"Your answer:",correct:"Correct:",retry:"Retry Exam",clear:"Clear Answers",failedLoad:"Failed to load exam file.",restart:"Restart",save:"Save",saved:"Saved Exams",enterName:"Enter a name:",savedTitle:"Saved Exams",open:"Open",del:"Delete",none:"No saved exams yet.",learnBanner:"Learn mode: explanations, key terms, and examples are shown.",showExp:"Show explanation",hideExp:"Hide explanation",keywords:"Key terms",example:"Example",modules:{admin:"Administration",safety:"Safety",project:"Projects & Sites",execution:"Execution of Work"}},fr:{title:"Examen RBQ",back:"← Tous les examens",prev:"Précédent",next:"Suivant",submit:"Soumettre",qOf:(i,t)=>`Question ${i} / ${t}`,result:"Résultat",yourScore:(s,t)=>`Votre note : <strong>${s}</strong> / ${t}`,review:"Révision",yourAnswer:"Votre réponse :",correct:"Bonne réponse :",retry:"Recommencer",clear:"Effacer les réponses",failedLoad:"Échec du chargement de l’examen.",restart:"Recommencer",save:"Enregistrer",saved:"Examens enregistrés",enterName:"Entrez un nom :",savedTitle:"Examens enregistrés",open:"Ouvrir",del:"Supprimer",none:"Aucun examen enregistré.",learnBanner:"Mode Apprendre : explications, mots clés et exemples.",showExp:"Afficher l’explication",hideExp:"Masquer l’explication",keywords:"Mots clés",example:"Exemple",modules:{admin:"Administration",safety:"Sécurité",project:"Gestion de projets et chantiers",execution:"Exécution des travaux"}};
const glossary=[{key:"RBQ",aliases:["rbq","régie du bâtiment"],en:{def:"Regulator for building safety & construction.",ex:"RBQ may suspend a licence for non-compliance."},fr:{def:"Régulateur de la sécurité des bâtiments et de la construction.",ex:"La RBQ peut suspendre une licence en cas de non-conformité."}},{key:"BSDQ",aliases:["bsdq"],en:{def:"System for depositing certain trade bids.",ex:"Trades file bids via BSDQ."},fr:{def:"Système de dépôt de certaines soumissions de métiers.",ex:"Les métiers déposent via le BSDQ."}},{key:"Lockout",aliases:["cadenassage","lockout","tagout"],en:{def:"Energy isolation procedure.",ex:"Prevents accidental startup."},fr:{def:"Isolement des énergies.",ex:"Empêche les démarrages involontaires."}},{key:"Firestopping",aliases:["coupe-feu","firestopping"],en:{def:"Maintains fire rating at penetrations.",ex:"Use a rated system around pipes."},fr:{def:"Maintient le degré coupe-feu.",ex:"Système homologué autour des tuyaux."}},{key:"Critical path",aliases:["chemin critique","critical path"],en:{def:"Longest dependent path sets duration.",ex:"Delay here delays project."},fr:{def:"Plus longue chaîne déterminant la durée.",ex:"Retard ici = retard projet."}}];
function findKeywords(t){t=t.toLowerCase();const hits=[];for(const g of glossary){for(const a of g.aliases){if(t.includes(a)){hits.push(g.key);break;}}}return [...new Set(hits)];}
function explanationBlock(q){const T=i18n[lang];const keys=findKeywords(q.question+" "+q.choices.join(" "));const defs=glossary.filter(g=>keys.includes(g.key));const correct=q.choices[q.answer];const why=(lang==='fr'?`Ici, « ${correct} » reflète la pratique courante pour ${i18n[lang].modules[moduleKey]}.`:`Here “${correct}” reflects common practice for ${i18n[lang].modules[moduleKey]}.`);const ex=defs.length?(lang==='fr'?`Exemple : ${defs[0].fr.ex}`:`Example: ${defs[0].en.ex}`):(lang==='fr'?`Exemple : confrontez chaque choix aux lois/normes/devis.`:`Example: contrast each choice with law/standards/specs.`);const chips=defs.length?`<div class="kdefs">${defs.map(d=>`<span class="chip" title="${(lang==='fr'?d.fr.def:d.en.def)}">${d.key}</span>`).join('')}</div>`:(lang==='fr'?'<em>Aucun mot clé détecté.</em>':'<em>No key terms detected.</em>');return `<div class="explain"><h4>${lang==='fr'?'Explication courte':'Short explanation'}</h4><p>${why}</p><p><strong>${T.keywords}:</strong></p>${chips}<p><strong>${T.example}:</strong> ${ex}</p></div>`;}
function qs(s){return document.querySelector(s)}function fmtTime(sec){const h=Math.floor(sec/3600),m=Math.floor((sec%3600)/60),s=sec%60;return [h,m,s].map(v=>String(v).padStart(2,'0')).join(':');}function defaultTime(){return (mode==='learn'?0:120*60)}
function saveProgress(){localStorage.setItem(`rbq_exam_${lang}_${moduleKey}_${examNumber}_${mode}_answers`,JSON.stringify(answers));localStorage.setItem(`rbq_exam_${lang}_${moduleKey}_${examNumber}_${mode}_index`,String(currentIndex));localStorage.setItem(`rbq_exam_${lang}_${moduleKey}_${examNumber}_${mode}_timeleft`,String(timeLeft));}
function loadProgress(){answers=JSON.parse(localStorage.getItem(`rbq_exam_${lang}_${moduleKey}_${examNumber}_${mode}_answers`)||"{}");const idx=localStorage.getItem(`rbq_exam_${lang}_${moduleKey}_${examNumber}_${mode}_index`);const t=localStorage.getItem(`rbq_exam_${lang}_${moduleKey}_${examNumber}_${mode}_timeleft`);if(idx!==null)currentIndex=parseInt(idx,10);if(t!==null)timeLeft=parseInt(t,10);}
function savedList(){try{return JSON.parse(localStorage.getItem('rbq_saved_exams_v3')||'[]')}catch(e){return[]}}function setSavedList(a){localStorage.setItem('rbq_saved_exams_v3',JSON.stringify(a))}
function saveSnapshot(){const T=i18n[lang];let name=prompt(T.enterName,`${lang.toUpperCase()} ${moduleKey.toUpperCase()} ${mode.toUpperCase()} – Exam ${examNumber} – ${new Date().toLocaleString()}`);if(name===null)return;name=String(name).trim()||`${lang.toUpperCase()} ${moduleKey.toUpperCase()} ${mode.toUpperCase()} – Exam ${examNumber} – ${new Date().toLocaleString()}`;const id=String(Date.now())+"_"+Math.random().toString(16).slice(2);const snap={id,name,lang,module:moduleKey,examNumber,mode,questions,answers,currentIndex,timeLeft,savedAt:new Date().toISOString(),version:3};const list=savedList();list.unshift(snap);setSavedList(list);showSaved();}
function showSaved(){const T=i18n[lang],modal=qs('#savedModal'),box=qs('#savedList');qs('#savedTitle').textContent=T.savedTitle;const data=savedList();box.innerHTML=data.length?data.map(s=>`<div class="saved-row"><div><div class="saved-name">${s.name}</div><div class="saved-meta">${s.lang.toUpperCase()} · ${(s.mode||'exam').toUpperCase()} · ${i18n[lang].modules[s.module]||s.module} · Exam ${s.examNumber} · ${new Date(s.savedAt).toLocaleString()}</div></div><div class="saved-actions"><button class="btn small" data-load="${s.id}">${T.open}</button><button class="btn small danger" data-del="${s.id}">${T.del}</button></div></div>`).join(''):`<p>${T.none}</p>`;box.querySelectorAll('[data-load]').forEach(b=>b.onclick=()=>{const id=b.getAttribute('data-load');loadSavedById(id);modal.hidden=true});box.querySelectorAll('[data-del]').forEach(b=>b.onclick=()=>{const id=b.getAttribute('data-del');setSavedList(savedList().filter(x=>x.id!==id));showSaved()});modal.hidden=false;}
function loadSavedById(id){const it=savedList().find(s=>s.id===id);if(!it)return;lang=it.lang;moduleKey=it.module;examNumber=it.examNumber;mode=it.mode||'exam';questions=it.questions;answers=it.answers||{};currentIndex=it.currentIndex||0;timeLeft=(typeof it.timeLeft==='number')?it.timeLeft:defaultTime();applyI18N();render();startTimer();}
function applyI18N(){const T=i18n[lang];document.documentElement.lang=lang;qs("#examTitle").textContent=T.title;qs("#backLink").textContent=T.back;qs("#backLink").href=`index.html?lang=${lang}&mode=${mode}&module=${moduleKey}`;qs("#prevBtn").textContent=T.prev;qs("#nextBtn").textContent=T.next;qs("#submitBtn").textContent=T.submit;qs("#restartBtn").textContent=T.restart;qs("#saveBtn").textContent=T.save;qs("#savedBtn").textContent=T.saved;qs("#modeBanner").textContent=(mode==='learn'?T.learnBanner:'');qs("#moduleBadge").textContent=i18n[lang].modules[moduleKey];}
(function init(){const p=new URLSearchParams(location.search);examNumber=p.get("exam")||"1";lang=(p.get("lang")||"en").toLowerCase()==="fr"?"fr":"en";mode=(p.get("mode")||"exam").toLowerCase()==="learn"?"learn":"exam";moduleKey=(p.get("module")||"admin").toLowerCase();applyI18N();qs('#savedBtn').onclick=showSaved;qs('#closeSaved').onclick=()=>{qs('#savedModal').hidden=true};qs('#savedModal').addEventListener('click',e=>{if(e.target===qs('#savedModal'))qs('#savedModal').hidden=true});qs('#restartBtn').onclick=()=>{answers={};currentIndex=0;timeLeft=defaultTime();saveProgress();qs('#result').style.display='none';render();startTimer();};qs('#saveBtn').onclick=saveSnapshot;const loadId=p.get('loadId');if(loadId){loadSavedById(loadId);return;}const folder=(lang==='fr'?{'admin':'questions_admin_fr','safety':'questions_safety_fr','project':'questions_project_fr','execution':'questions_execution_fr'}:{'admin':'questions_admin','safety':'questions_safety','project':'questions_project','execution':'questions_execution'})[moduleKey]||'questions_admin';const file=`${folder}/exam${examNumber}.json`;fetch(file).then(r=>r.json()).then(data=>{questions=data.slice();if(timeLeft==null)timeLeft=defaultTime();loadProgress();render();startTimer();window.addEventListener('beforeunload',saveProgress);document.addEventListener('keydown',e=>{if(e.key==='ArrowRight')goNext();if(e.key==='ArrowLeft')goPrev();});}).catch(err=>{qs('#exam-container').innerHTML=`<p style="color:#b00">${i18n[lang].failedLoad} ${err}</p>`});})();function render(){const T=i18n[lang];const q=questions[currentIndex];if(!q)return;const cont=qs('#exam-container');qs('#progressText').innerHTML=T.qOf(currentIndex+1,questions.length);let expBtn='';if(mode==='learn'){expBtn=`<button class="btn small" id="toggleExp">${T.hideExp}</button>`}cont.innerHTML=`<div class="question"><strong>${currentIndex+1}.</strong> ${q.question} ${expBtn}</div>${q.choices.map((c,i)=>`<button class="choice-btn ${answers[currentIndex]===i?'selected':''}" data-i="${i}">${c}</button>`).join('')}${mode==='learn'?explanationBlock(q):''}`;cont.querySelectorAll('.choice-btn').forEach(btn=>btn.onclick=()=>{answers[currentIndex]=parseInt(btn.dataset.i,10);saveProgress();render();});if(mode==='learn'){const btn=qs('#toggleExp');let shown=true;btn&&btn.addEventListener('click',()=>{shown=!shown;const el=cont.querySelector('.explain');if(el)el.style.display=shown?'block':'none';btn.textContent=shown?T.hideExp:T.showExp;});}qs('#prevBtn').onclick=()=>{if(currentIndex>0){currentIndex--;render();saveProgress();}};qs('#nextBtn').onclick=()=>{if(currentIndex<questions.length-1){currentIndex++;render();saveProgress();}};qs('#submitBtn').onclick=submitExam;}
function startTimer(){clearInterval(timer);if(mode==='learn'){qs('#timer').textContent='—';return;}timeLeft=(typeof timeLeft==='number')?timeLeft:120*60;timer=setInterval(()=>{qs('#timer').textContent=fmtTime(timeLeft);if(timeLeft<=0){clearInterval(timer);submitExam();return;}timeLeft--;if(timeLeft%5===0)saveProgress();},1000);}
function submitExam(){const T=i18n[lang];let score=0;questions.forEach((q,idx)=>{if(answers[idx]===q.answer)score++});const pct=Math.round((score/questions.length)*100);const res=qs('#result');res.style.display='block';res.innerHTML=`<h2>${T.result}</h2><p>${T.yourScore(score,questions.length)} <span class="badge">${pct}%</span></p><div class="review"><h3>${T.review}</h3>${questions.map((q,idx)=>{const user=answers[idx],ok=user===q.answer;const uTxt=(user!=null?q.choices[user]:'<em>—</em>');return `<details ${!ok?'open':''}><summary>${idx+1}. ${ok?'✅':'❌'} ${q.question}</summary><div><strong>${T.yourAnswer}</strong> ${uTxt}</div><div><strong>${T.correct}</strong> ${q.choices[q.answer]}</div>${mode==='learn'?explanationBlock(q):''}</details>`}).join('')}</div><p><button class="primary" id="retryBtn">${T.retry}</button><button id="clearBtn">${T.clear}</button></p>`;qs('#retryBtn').onclick=()=>{answers={};currentIndex=0;timeLeft=120*60;saveProgress();res.style.display='none';startTimer();render();};qs('#clearBtn').onclick=()=>{localStorage.removeItem(`rbq_exam_${lang}_${moduleKey}_${examNumber}_${mode}_answers`);localStorage.removeItem(`rbq_exam_${lang}_${moduleKey}_${examNumber}_${mode}_index`);localStorage.removeItem(`rbq_exam_${lang}_${moduleKey}_${examNumber}_${mode}_timeleft`);answers={};res.style.display='none';render();};}
